## 24.07.15

기본 프로젝트 세팅은 다했고,

린트 프리티어 시퀄라이즈 mysql업 노드몬

이제 주요기능 flow + 테이블 구상 하면 됨.

왜 vscode에서 lint 오류를 안띄워 주는지 모르겠다. 이것저것 다해봤는데 안됨.
yarn에서 뭔가 걸리는거같은데, 그냥 터미널에서 lint는 잘됨. 시간 아까워서 그냥 진행중.

## 24.07.16

테이블 구상

#### 주문서

- 유저
- 어떤쿠폰 (쿠폰이름? 비비큐황올? 이런거?)
- 언제주문
- 얼마나
- 상태

#### 쿠폰

- 핀번호
- 만료일자
- 생성일자
- 상태
- 주문서 id?

---

1. 어떤쿠폰? 인지는 쿠폰 가져올때도 필요할거같은데,
2. 쿠폰을 많이 찍어내면, 만료일자, 생성일자 중복이 엄청많을텐데?
3. 쿠폰과 주문서가 연결될 로직이 있는가?
4. 주문서의 status는 pending | succeed | failed
5. 쿠폰의 status는 사용가능, 사용했음, 취소됨.
6. hard delete? soft delete?

1번, 2번을 고려했을때, 쿠폰 메타데이터? 같은걸로 따로 빼내는게 나을듯.

#### 쿠폰 메타데이터(미정)

- id
- 어떤쿠폰 (쿠폰이름? 비비큐황올? 이런거?)
- 만료일자
- 생성일자

#### 주문서

- id
- 유저
- 쿠폰 메타데이터 포린키
- 언제주문 (생성일자와 겹치나?)
- 얼마나
- 상태

#### 쿠폰

- 핀번호
- 쿠폰 메타데이터 포린키
- 상태
- 주문서 id? (미정)
- 사용시각

이러면 쿠폰 전체에 변경사항 있을때, 일괄적용 가능, 더러운 중복제거 까지

일단 요구사항만 봤을땐, 적절한 테이블인듯.

막 드는 생각은,

1. 지금은 주문서를 넣으면 바로 쿠폰생성.

   근데 검토하고나서 생성 허가? -> (언제주문 이랑 생성일자가 달라짐 -> 둘다 필요)

2. 지금은 쿠폰의 만료기한을 전부 동일하게 함.

   쿠폰 개별로 막 사용기한 늘려달라 요청 같은 요구사항이 생긴다면? -> 어쩔수없이 쿠폰 테이블에 일자 넣어야겠지

3. 쿠폰 메타데이터 테이블을 구상하고 난 지금은, 쿠폰을 가져올때 어떤쿠폰인지 볼려면, 쿠폰 메타데이터에 접근하면 됨.

   주문서에서도 마찬가지로 메타데이터로 접근하면 됨.

   주문서로 만들어진 쿠폰을 싹다 가져오는것도, 메타데이터 포린키를 이용하면 됨. 뭐 얼마나 썼는지 통계를 보기위해서 같은.

   그러니까, 쿠폰테이블에 주문서 포린키는 필요한가? -> 근데 메타데이터 포린키는 메타데이터 보기위한 목적으로 쓰는게 맞을거 같기도? 주문서에 귀속?된 쿠폰을 가져오는데 메타데이터 키를 쓴다? 문제는 없겠지만.

4. 주문서 insert flow는, metadata 생성, 주문서 생성, 쿠폰 생성 으로 생각중이었는데, 메타데이터 insert가 실패하면 주문이 들어왔는데 주문서가 안만들어지는 상황이 생김.

   주문서에 메타데이터 참조키 컬럼을 nullable로 해야할듯. 일단 주문오면 주문서 부터 만들어야함.

5. 쿠폰취소는 간단할듯. status두고 soft delete처럼 쓰면 그냥 업데이트만 하면 됨. -> 요구사항엔 없지만 뭐 날마다 스케쥴 돌려서 삭제하면 될듯

6. 쿠폰테이블에서, 참조키?

   막 천개 만개 쿠폰 찍어낸다고 생각할때, 참조키 인덱스가 겁나 커짐. 주문서 id로 쿠폰 싹 긁어오는 로직이 자주 안쓰인다? 굳이 참조키 필요?

   참조키 걸지말고 그냥 낫널로 해놓고 무결성을 조금은 챙긴다.

   성능테스트 해보면 괜찮을듯.

---

모델 작성하면서 든 생각인데, 쿠폰이 언제쓰였는지 정보가 있어야할듯?

## 24.07.17

로깅, 에러처리 기본코드는 다짰음.

비즈니스 로직 짜면 됨.

주요 로직은, 주문이랑 쿠폰취소.

쿠폰취소를 읽어보면

단, 쿠폰 발행 취소 과정에서 에러가 발생할 경우, 쿠폰 데이터와
주문서의 상태는 원상 복구가 되어야 합니다

라고 하는데,

API 인풋과 아웃풋이 쿠폰 id인데 주문서에 영향이 갈 일이 있나?

쿠폰 개별 취소 로직이 아닌건가?

요구사항을 보면 트랜잭션 롤백을 요구하는거 같고, 뭔가 주문서로 만들어진 쿠폰을

싹다 취소하는 로직을 말하는거 같기도 한데, 주문서 취소를 요구하는거면 인풋이 주문서 id여야 하는데?

쿠폰 개별취소가 맞는거 같은데, 개별취소 해도 내가 짠 테이블에서는 주문서에 영향이 안감.

트랜잭션을 요구하는거 같은데, 쿠폰취소는 그냥 status 업데이트 -> 싱글쿼리라서 트랜잭션 필요없을듯.

애매하면 뭐 둘다 뚝딱 만들면 되니까 우선은 쿠폰 개별취소를 만든다.

---

주문생성 api 완료, 10만개 1.4초, 100만개 14초 걸림 (쿠폰테이블에 참조키 안걸고)

주문 조회 api가 있긴한데, 메타데이터나 쿠폰 조인하는 로직 추가해야함. 지금은 그냥 order만 가져옴
